# 일일결산 자동화 시스템

안과 검사실의 일일 통계를 자동으로 수집하고 PDF 보고서를 생성하는 Python GUI 프로그램입니다.

## 주요 기능

- **자동 파일 스캔**: 8개 검사 장비의 백업 디렉토리에서 오늘 생성된 파일/폴더 자동 스캔
- **차트번호 추출**: 정규식 패턴 매칭으로 파일명에서 차트번호 자동 추출
- **중복 제거**: 같은 환자의 양안 검사(R/L)를 1명으로 카운트
- **특수 계산**: 녹내장(HFA∩OCT), 라식(ORB∩TOPO), 안저(FUNDERS+OPTOS) 자동 계산
- **예약 파일 처리**: 엑셀 예약 파일에서 수술 키워드 검색 및 집계
- **엑셀/PDF 생성**: 템플릿 기반 엑셀 자동 작성 및 PDF 변환
- **사용자 친화적 GUI**: tkinter 기반의 직관적인 인터페이스

## 시스템 요구사항

### 필수 요구사항
- Python 3.8 이상
- Windows OS (PDF 변환 기능 사용 시)
- Microsoft Excel 설치 (PDF 변환 기능 사용 시)

### Python 패키지
- openpyxl (엑셀 처리)
- pandas (데이터 처리)
- pywin32 (Windows에서 PDF 변환)

## 설치 방법

### 1. Python 설치 확인
```bash
python --version
```

Python이 설치되어 있지 않다면 [python.org](https://www.python.org)에서 다운로드하여 설치하세요.

### 2. 프로젝트 다운로드
프로젝트 파일을 원하는 위치에 저장합니다.

### 3. 필요 패키지 설치
```bash
pip install -r requirements.txt
```

Windows에서 pywin32 설치 후 추가 작업이 필요할 수 있습니다:
```bash
python Scripts/pywin32_postinstall.py -install
```

## 설정

### config.json 설정

프로그램 실행 전에 `config.json` 파일을 환경에 맞게 수정해야 합니다.

#### 필수 수정 항목

1. **템플릿 파일 경로**
```json
"template_file": "D:\\결산\\일일결산_템플릿.xlsx"
```

2. **PDF 출력 경로**
```json
"output_pdf": "D:\\결산\\PDF\\일일결산_{date}.pdf"
```

3. **장비별 백업 경로**
```json
"equipment": {
  "SP": {
    "path": "D:\\BACKUP\\SP",
    ...
  },
  "TOPO": {
    "path": "D:\\BACKUP\\TOPO",
    ...
  },
  ...
}
```

4. **네트워크 경로 (안저)**
```json
"special_items": {
  "안저": {
    "folders": [
      "\\\\192.168.0.213\\Images\\FUNDERS",
      "\\\\192.168.0.213\\Images\\Secondary"
    ]
  }
}
```

5. **직원 명단**
```json
"staff_list": [
  "김창범", "김수지", "김대혁", "김민지",
  "박현진", "고은서", "김현호", "임량현",
  "유예나", "김태호"
]
```

### 엑셀 템플릿 준비

`D:\결산\일일결산_템플릿.xlsx` 파일을 준비하고, 다음 사항을 확인하세요:

- 시트명: `복구됨_Sheet2`
- 날짜 셀: A4
- 근무인원 셀: B6
- 각 검사 항목의 셀 위치가 config.json과 일치하는지 확인

## 사용 방법

### 프로그램 실행

```bash
python daily_report.py
```

또는 Windows에서 `daily_report.py` 파일을 더블클릭하여 실행할 수 있습니다.

### 사용 절차

1. **근무 인원 선택**
   - 오늘 근무한 직원을 체크박스로 선택합니다
   - 기본값으로 모든 직원이 선택되어 있습니다

2. **예약 파일 선택 (선택사항)**
   - "파일 선택..." 버튼을 클릭하여 예약 엑셀 파일을 선택합니다
   - 여러 파일을 동시에 선택할 수 있습니다
   - 예약 파일이 없으면 건너뛸 수 있습니다

3. **수기 입력**
   - FAG (형광안저촬영) 건수를 입력합니다
   - 안경검사 건수를 입력합니다
   - 해당 검사가 없으면 0으로 남겨둡니다

4. **결산 실행**
   - "🚀 결산 실행" 버튼을 클릭합니다
   - 우측 로그 영역에서 실시간 진행 상황을 확인할 수 있습니다
   - 완료되면 PDF 파일이 자동으로 열립니다

### 실행 결과

프로그램이 성공적으로 실행되면:

1. 임시 엑셀 파일 생성 (`일일결산_YYYYMMDD_temp.xlsx`)
2. PDF 변환 (`D:\결산\PDF\일일결산_YYYYMMDD.pdf`)
3. PDF 파일 자동으로 열림
4. 임시 엑셀 파일 자동 삭제

## 데이터 수집 방식

### Type A: 자동 파일 스캔 (8개 장비)

각 장비의 백업 디렉토리에서 오늘 생성된 파일을 스캔하고 차트번호를 추출합니다.

| 장비 | 경로 | 스캔 대상 |
|------|------|-----------|
| SP (내피) | D:\BACKUP\SP | 파일 |
| TOPO (Tomey) | D:\BACKUP\TOPO | 파일 |
| ORB | D:\BACKUP\ORB | 파일 |
| OCT | D:\BACKUP\OCT | 파일 + 폴더 |
| HFA (시야) | D:\BACKUP\HFA | 파일 |
| OQAS (백내장) | D:\BACKUP\OQAS | 파일 |
| IOL700 (Verion) | D:\BACKUP\IOL700 | 파일 |

### 특수 계산 항목

- **녹내장**: HFA와 OCT에서 모두 검사받은 환자 (교집합)
- **라식**: ORB와 TOPO에서 모두 검사받은 환자 + SCR 폴더 추가
- **안저**: FUNDERS 폴더 + OPTOS 폴더 (네트워크 경로)

### Type B: 예약 파일 처리

예약 엑셀 파일에서 "수술방법:" 키워드가 포함된 셀을 찾아 다음 수술 유형을 집계합니다:

- **Verion (Toric)**: "toric" 키워드
- **Lensx**: "lens x", "lensx", "vivity" 키워드
- **EX500/FS200**: "라식", "라섹", "lasik", "lasek", "올레이저" 키워드

### Type C: 수기 입력

- **FAG** (형광안저촬영)
- **안경검사**

## 문제 해결

### PDF 변환이 안 될 때

1. Microsoft Excel이 설치되어 있는지 확인
2. pywin32가 올바르게 설치되었는지 확인:
   ```bash
   pip install --upgrade pywin32
   python Scripts/pywin32_postinstall.py -install
   ```
3. Excel을 관리자 권한으로 한 번 실행해보기

PDF 변환이 실패해도 엑셀 파일은 생성되므로, 수동으로 PDF로 변환할 수 있습니다.

### 특정 장비 경로가 없을 때

- 로그에 "⚠️ 경로 없음" 경고가 표시되지만 프로그램은 계속 실행됩니다
- config.json에서 해당 장비의 경로를 올바르게 설정하세요

### 차트번호가 제대로 추출되지 않을 때

- config.json의 정규식 패턴을 확인하세요
- 파일명 예시를 확인하고 패턴을 조정할 수 있습니다

### 예약 파일 처리 오류

- 예약 파일이 손상되지 않았는지 확인
- 파일이 다른 프로그램에서 열려있지 않은지 확인
- 파일 형식이 .xlsx 또는 .xls인지 확인

## 파일 구조

```
일일결산/
├── daily_report.py      # 메인 프로그램
├── config.json          # 설정 파일
├── requirements.txt     # 필요 패키지 목록
└── README.md           # 사용 설명서
```

## 주의사항

1. **Windows 경로 표기**: config.json에서 백슬래시를 이중으로 사용해야 합니다 (`D:\\BACKUP\\SP`)
2. **네트워크 경로**: 백슬래시를 4개 사용합니다 (`\\\\192.168.0.213\\Images`)
3. **인코딩**: 한글 파일명과 경로를 올바르게 처리하기 위해 UTF-8 인코딩을 사용합니다
4. **파일 날짜**: 파일의 생성 시간(ctime)을 기준으로 오늘 날짜를 비교합니다
5. **차트번호 범위**: 1 ~ 210,000 범위 내의 숫자만 유효합니다

## 업데이트 내역

### v1.0.0 (2025-11-14)
- 최초 버전 릴리스
- 8개 장비 자동 스캔 기능
- 특수 항목 계산 (녹내장, 라식, 안저)
- 예약 파일 처리 기능
- 엑셀/PDF 자동 생성
- GUI 인터페이스

## 라이선스

이 프로그램은 안과 검사실 내부 사용을 위해 개발되었습니다.

## 문의

프로그램 사용 중 문제가 발생하거나 기능 개선이 필요한 경우, IT 담당자에게 문의하세요.
